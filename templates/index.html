{% extends "base.html" %}

{% block title %}
    <title>Frida Script Runner | Main Menu</title>
{% endblock %}

{% block body %}

<div class="container1">
  <div class="justify-content-center logo">
    <img src="{{ url_for('static', filename='img/FSR-logo.png') }}" class="size-logo mt-3" alt="logo">
    <h2 class="text-center white">Frida Script Runner</h2>
  </div>
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0"><i class="bi bi-terminal"></i> Frida Tool</h2>
        </div>
        <div class="card-body bg-white">
          <div class="p-3 border rounded bg-white">
            <form action="/run-frida">
              <div class="row mb-3">
                <div class="col-8">
                  <h3 class="h6 fw-bold text-dark"><i class="bi bi-phone"></i> Connected Devices</h3>
                  {% if connected_device %}
                    {% for device in connected_device %}
                      {% if "serial_number" in device | lower %}
                        <p class="mb-1">Android Device: <i class="bi bi-android text-success"></i> {{ device.model }}</p>
                        <p class="mb-1">Serial: {{ device.serial_number }}</p>
                        <p class="mb-1">Android Version: {{device.versi_andro}}</p>
                      {% else %}
                        <p class="mb-1">Device: <i class="bi bi-apple text-dark"></i> {{ device.model }}</p>
                        <p class="mb-1">UDID: {{ device.UDID }}</p>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <p class="text-danger">No device connected</p>
                  {% endif %}
                </div>
                <div class="col-4 text-end">
                  <a class="btn btn-outline-primary" href="/features" role="button">Other Features</a>
                </div>
              </div>
              
              <!-- Frida Server Status -->
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h3 class="h6 fw-bold text-dark mb-0"><i class="bi bi-server"></i> Frida Server Status</h3>
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="manualRefreshStatus()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                  </button>
                </div>
                {% if frida_status %}
                  {% for device_id, status in frida_status.items() %}
                    <div class="card border-0 bg-light mb-2" data-device-id="{{ device_id }}">
                      <div class="card-body p-2">
                        <div class="row align-items-center">
                          <div class="col-8">
                            <small class="text-muted">
                              {% if "device_id" in status.device_info %}
                                <i class="bi bi-android text-success"></i> {{ status.device_info.model }}
                              {% else %}
                                <i class="bi bi-apple text-dark"></i> {{ status.device_info.model }}
                              {% endif %}
                            </small>
                            <div class="d-flex align-items-center mt-1">
                              <span class="badge {% if status.installed %}bg-success{% else %}bg-warning{% endif %} me-2">
                                <i class="bi {% if status.installed %}bi-check-circle{% else %}bi-exclamation-triangle{% endif %}"></i>
                                {% if status.installed %}
                                  {% if status.frida_server_name %}{{ status.frida_server_name }}{% else %}Installed{% endif %}
                                {% else %}Not Installed{% endif %}
                              </span>
                              <span class="badge {% if status.running %}bg-success{% else %}bg-danger{% endif %}">
                                <i class="bi {% if status.running %}bi-play-circle{% else %}bi-stop-circle{% endif %}"></i>
                                {% if status.running %}Running{% else %}Stopped{% endif %}
                              </span>
                            </div>
                          </div>
                          <div class="col-4 text-end">
                            {% if "device_id" in status.device_info %}
                              {% if not status.running %}
                                <div class="d-flex flex-column gap-1">
                                  <button class="btn btn-sm btn-success start-frida-server" data-device-id="{{ device_id }}">
                                    <i class="bi bi-play-fill"></i> Start
                                  </button>
                                  <div class="form-check form-check-sm">
                                    <input class="form-check-input force-download-checkbox" type="checkbox" id="force-download-{{ device_id }}">
                                    <label class="form-check-label small" for="force-download-{{ device_id }}">
                                      Force Download
                                    </label>
                                  </div>
                                </div>
                              {% else %}
                                <button class="btn btn-sm btn-danger stop-frida-server" data-device-id="{{ device_id }}">
                                  <i class="bi bi-stop-fill"></i> Stop
                                </button>
                              {% endif %}
                            {% else %}
                              <span class="text-muted small">iOS - No Server Needed</span>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <small>No devices connected or Frida server status unavailable</small>
                  </div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="search-packages" class="form-label">Search Packages</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input name="search-packages" type="text" class="form-control" id="searchInput" oninput="filterOptions()" placeholder="Search for package...">
                </div>
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="packageSelect" class="form-label">Select Package</label>
                  <select name="package" id="packageSelect" class="form-select" required>
                    <option disabled selected>Loading packages...</option>
                  </select>
                  <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadPackages()">
                      <i class="bi bi-arrow-clockwise"></i> Refresh Packages
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning ms-2" onclick="restartFridaServer()">
                      <i class="bi bi-arrow-clockwise"></i> Restart Frida Server
                    </button>
                    <small class="text-muted d-block mt-1">Start Frida Server first, then click Refresh. Use Restart if packages don't load.</small>
                  </div>
                </div>
      
                <div class="col-md-6">
                  <label for="selected_script" class="form-label">Select Bypass Script</label>
                  <select name="selected_script" id="selectedScript" class="form-select" onchange="toggleAutoGenerateInput()">
                    <optgroup label="Android Scripts" data-directory="Script Directory 1">
                      {% for script in bypass_scripts_android %}
                        <option value="{{ script['file_name'] }}">{{ script['description'] }} - {{ script['file_name'] }}</option>
                      {% endfor %}
                    </optgroup>
                    <optgroup label="iOS Scripts" data-directory="Script Directory 2">
                      {% for script in bypass_scripts_ios %}
                        <option value="{{ script['file_name'] }}">{{ script['description'] }} - {{ script['file_name'] }}</option>
                      {% endfor %}
                    </optgroup>
                    <optgroup label="AI Generated">
                      <option value="auto_generate">Auto Generate Script</option>
                    </optgroup>
                  </select>
                </div>
              </div>
              
              <!-- Auto Generate Script Input -->
              <div class="mb-3" id="autoGenerateDiv" style="display: none;">
                <label for="autoGeneratePrompt" class="form-label">
                  <i class="bi bi-magic"></i> Describe what you want to hook or bypass
                </label>
                <textarea class="form-control" id="autoGeneratePrompt" rows="3" 
                          placeholder="Examples:&#10;• Hook MainActivity.onCreate method&#10;• Bypass SSL pinning in OkHttp library&#10;• Hook native function strcmp in libc.so&#10;• Intercept calls to SharedPreferences.getString&#10;• Bypass root detection in RootBeer library&#10;• Hook Java.use('android.telephony.TelephonyManager').getDeviceId"></textarea>
                <div class="mt-2">
                  <small class="text-muted">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Examples:</strong><br>
                    • <strong>Java Classes:</strong> Hook MainActivity.onCreate method<br>
                    • <strong>Native Libraries:</strong> Hook strcmp function in libc.so<br>
                    • <strong>Security Bypass:</strong> Bypass SSL pinning in OkHttp<br>
                    • <strong>API Methods:</strong> Intercept TelephonyManager.getDeviceId calls
                  </small>
                </div>
                <div class="mt-2">
                  <button type="button" class="btn btn-success btn-sm" onclick="generateFridaScript()">
                    <i class="bi bi-cpu"></i> Generate Script
                  </button>
                </div>
              </div>
              
              <br>
              <!-- frida codeshare search -->
              <div class="mb-3">
                <label for="codeshareSearchInput" class="form-label">Search Frida Codeshare Script</label>
                <input type="text" class="form-control" id="codeshareSearchInput" placeholder="Search Frida script..." autocomplete="off">
                                
                <div class="modal fade" id="codeshareResultsModal" tabindex="-1" aria-labelledby="codeshareResultsLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                      <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Search Frida Codeshare Script</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <input type="text" id="modalSearchInput" class="form-control mb-3" placeholder="Search in modal...">
                        <div id="modalResults"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="script_content" class="form-label">Script Content</label>
                <textarea class="form-control" name="script_content" id="scriptContent" rows="5" placeholder="Script Content" style="height: 150px;"></textarea>
              </div>
    
              <div class="d-flex justify-content-between align-items-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="0" name="use_custom_script" id="customScriptCheckbox" onchange="toggleCustomScript()">
                  <label class="form-check-label" for="use_custom_script">
                    Use Custom Script
                  </label>
                </div>
                <div>
                  <button type="button" class="btn btn-primary" id="runBtn">
                    <i class="bi bi-play-fill"></i> Run Frida
                  </button>
                  <button type="button" class="btn btn-outline-danger" id="stopBtn">
                    <i class="bi bi-stop-fill"></i> Stop
                  </button>
                  <button type="button" class="btn btn-outline-warning" id="fixBtn" style="display: none;">
                    <i class="bi bi-tools"></i> Fix Script
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-6">
      <div class="terminal-fsr mb-3" style="height: 300px;">
        <div class="head-terminal">
          <div class="row g-0 align-items-center">
            <div class="col-auto">
              <div class="d-flex flex-row">
                <div class="circle-red"></div>
                <div class="circle-yellow"></div>
                <div class="circle-green"></div>
              </div>
            </div>
            <div class="col title-fsr ps-2">
              <span>FSR Logs</span>
            </div>
            <div class="col-auto">
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFSRLogs()">
                <i class="bi bi-trash"></i> Clear
              </button>
            </div>
          </div>
        </div>
        <div class="cli" style="height: calc(100% - 38px); overflow-y: auto;">
          <div class="cli-content p-2" id="outputContainer">
          </div>
        </div>
      </div>
      
      <div class="terminal-fsr" style="height: 400px;">
        <div class="head-terminal">
          <div class="row g-0 align-items-center">
            <div class="col-auto">
              <div class="d-flex flex-row">
                <div class="circle-red"></div>
                <div class="circle-yellow"></div>
                <div class="circle-green"></div>
              </div>
            </div>
            <div class="col title-fsr ps-2">
              <span>Frida Logs</span>
            </div>
          </div>
        </div>
        <div class="cli" style="height: calc(100% - 38px); overflow-y: auto;">
          <div class="cli-content-terminal p-2" id="clearOutput">
            <p class="wraptext mb-0" id="outputFrida"></p>
            <div id="output-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="footer">
    <a class="credit" href="https://secrash.com" target="_blank"><span>2025 © Secrash</span></a>
  </div>
</div>
<script src="{{ url_for('static', filename='js/custom.js') }}"></script>

{% endblock %}